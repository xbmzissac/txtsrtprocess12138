<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>在线SRT处理工具</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .upload-box {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        #preview {
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 15px;
            max-height: 300px;
            overflow: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>SRT文件处理工具</h1>
    
    <!-- 文件上传区域 -->
    <div class="upload-box">
        <input type="file" id="fileInput" accept=".srt">
        <p>拖放SRT文件至此或点击选择</p>
    </div>

    <!-- 处理进度显示 -->
    <div id="processingStatus" class="hidden">
        <p>处理进度：<span id="progressText">0%</span></p>
        <div id="progressBar" style="height:5px;background:#ddd;width:100%">
            <div id="progress" style="height:100%;background:#4CAF50;width:0%"></div>
        </div>
    </div>

    <!-- 结果预览 -->
    <div id="resultSection" class="hidden">
        <h3>处理结果预览</h3>
        <div id="preview"></div>
        <button onclick="downloadResult()">下载TXT文件</button>
    </div>

    <script>
        // 配置API密钥（需要替换为你的实际密钥）
        const API_KEY = 'sk-3c45ea45fb0648aeac327250131ebd51';

        // 初始化变量
        let processedContent = '';
        
        // 文件选择事件监听
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showProcessingUI(true);
            try {
                const content = await file.text();
                const cleaned = cleanSRT(content);
                processedContent = await processWithAI(cleaned);
                showResult(processedContent);
            } catch (error) {
                alert('处理失败: ' + error.message);
            } finally {
                showProcessingUI(false);
            }
        });

        // 清理SRT格式
        function cleanSRT(content) {
            return content
                .replace(/\d+\n\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3}\n/g, '')
                .replace(/^\d+$\n?/gm, '');
        }

        // 调用AI处理
        async function processWithAI(text) {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{
                        role: "user",
                        content: `将命令词改为 你是一个专业文本分段助手，请严格按照以下规则处理：
1. 按对话轮换划分段落，不同说话者独立成段
2. 同一说话者的连续短句合并为一段，用标点连接
3. 语义场景转换时用空行分隔
4. 保留原始文本内容，不添加额外说明
5. 去除时间戳和序号，只保留对话内容

处理文本：
${text}`
                    }],
                    temperature: 0.1
                })
            });

            if (!response.ok) throw new Error(`API错误: ${response.status}`);
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // 显示处理进度
        function showProcessingUI(show) {
            document.getElementById('processingStatus').classList.toggle('hidden', !show);
            if (show) {
                let progress = 0;
                const interval = setInterval(() => {
                    progress = Math.min(progress + Math.random() * 10, 95);
                    updateProgress(progress);
                    if (!show) clearInterval(interval);
                }, 500);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progressText').textContent = Math.round(percent) + '%';
        }

        // 显示结果
        function showResult(content) {
            document.getElementById('preview').textContent = content;
            document.getElementById('resultSection').classList.remove('hidden');
        }

        // 下载结果
        function downloadResult() {
            const blob = new Blob([processedContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `processed_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 拖放文件支持
        document.addEventListener('dragover', (e) => e.preventDefault());
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.srt')) {
                document.getElementById('fileInput').files = e.dataTransfer.files;
                document.getElementById('fileInput').dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>